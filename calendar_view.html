document.addEventListener("DOMContentLoaded", function () {
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "ko",
        editable: true,
        selectable: true,
        contentHeight: "auto",

        events: async function (fetchInfo, successCallback, failureCallback) {
            console.log("ðŸ“¡ Firebaseì—ì„œ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸°...");
            const year = fetchInfo.start.getFullYear();
            const month = String(fetchInfo.start.getMonth() + 1).padStart(2, '0');

            try {
                const snapshot = await db.ref(`calendar/${year}/${month}`).once("value");
                if (!snapshot.exists()) {
                    console.log("ðŸ“­ ì¼ì • ì—†ìŒ");
                    successCallback([]);
                    return;
                }

                let events = [];
                snapshot.forEach(daySnapshot => {
                    const day = daySnapshot.key;
                    daySnapshot.forEach(eventSnapshot => {
                        const event = eventSnapshot.val();
                        console.log("ðŸ”¥ ê°€ì ¸ì˜¨ ì¼ì • ë°ì´í„°:", JSON.stringify(event));

                        // âœ… ë°ì´í„°ê°€ undefinedë©´ ë¬¸ì œ ë°œìƒ
                        if (!event || !event.name) {
                            console.error("ðŸš¨ ìž˜ëª»ëœ ì´ë²¤íŠ¸ ë°ì´í„°:", event);
                            return;
                        }

                        events.push({
                            id: eventSnapshot.key,
                            title: event.name,
                            start: `${year}-${month}-${String(day).padStart(2, '0')}`,
                            color: event.color || "black" // ê¸°ë³¸ê°’ ì¶”ê°€
                        });
                    });
                });

                console.log("âœ… ìµœì¢… ë¶ˆëŸ¬ì˜¨ ì¼ì • ë¦¬ìŠ¤íŠ¸:", JSON.stringify(events));
                successCallback(events);
            } catch (error) {
                console.error("ðŸš¨ ì´ë²¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
                failureCallback(error);
            }
        },

        dateClick: async function(info) {
            let name = prompt("ì¼ì • ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”:");
            if (name) {
                await addEvent(info.date, name, selectedColor);
            }
        },

        eventClick: function(info) {
            if (confirm("ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                deleteEvent(info.event);
            }
        }
    });

    calendar.render();

    async function addEvent(date, name, color) {
        let year = date.getFullYear();
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let day = String(date.getDate()).padStart(2, '0');

        const newRef = db.ref(`calendar/${year}/${month}/${day}`).push();
        await newRef.set({ name, color });

        console.log("âœ… ì¼ì • ì €ìž¥ ì™„ë£Œ:", { name, color });

        // âœ… ìƒˆ ì¼ì • ì¦‰ì‹œ ë°˜ì˜
        calendar.addEvent({
            id: newRef.key,
            title: name,
            start: `${year}-${month}-${day}`,
            color: color
        });

        console.log("ðŸ”„ ì¼ì • ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰");
        setTimeout(() => {
            calendar.refetchEvents();
        }, 500);
    }

    async function deleteEvent(event) {
        let dateParts = event.startStr.split("-");
        let year = dateParts[0];
        let month = dateParts[1];
        let day = dateParts[2];

        console.log("ðŸ—‘ï¸ ì‚­ì œ ìš”ì²­:", event);

        await db.ref(`calendar/${year}/${month}/${day}/${event.id}`).remove();
        event.remove();
        console.log("ðŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ:", event.id);

        setTimeout(() => {
            calendar.refetchEvents();
        }, 500);
    }
});

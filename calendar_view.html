document.addEventListener("DOMContentLoaded", function () {
    var calendarEl = document.getElementById("calendar");
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "ko",
        editable: true,
        selectable: true,
        contentHeight: "auto",

        events: async function (fetchInfo, successCallback, failureCallback) {
            console.log("📡 Firebase에서 일정 불러오기...");
            const year = fetchInfo.start.getFullYear();
            const month = String(fetchInfo.start.getMonth() + 1).padStart(2, '0');

            try {
                const snapshot = await db.ref(`calendar/${year}/${month}`).once("value");
                if (!snapshot.exists()) {
                    console.log("📭 일정 없음");
                    successCallback([]);
                    return;
                }

                let events = [];
                snapshot.forEach(daySnapshot => {
                    const day = daySnapshot.key;
                    daySnapshot.forEach(eventSnapshot => {
                        const event = eventSnapshot.val();
                        console.log("🔥 가져온 일정 데이터:", JSON.stringify(event));

                        // ✅ 데이터가 undefined면 문제 발생
                        if (!event || !event.name) {
                            console.error("🚨 잘못된 이벤트 데이터:", event);
                            return;
                        }

                        events.push({
                            id: eventSnapshot.key,
                            title: event.name,
                            start: `${year}-${month}-${String(day).padStart(2, '0')}`,
                            color: event.color || "black" // 기본값 추가
                        });
                    });
                });

                console.log("✅ 최종 불러온 일정 리스트:", JSON.stringify(events));
                successCallback(events);
            } catch (error) {
                console.error("🚨 이벤트 불러오기 오류:", error);
                failureCallback(error);
            }
        },

        dateClick: async function(info) {
            let name = prompt("일정 이름을 입력하세요:");
            if (name) {
                await addEvent(info.date, name, selectedColor);
            }
        },

        eventClick: function(info) {
            if (confirm("일정을 삭제하시겠습니까?")) {
                deleteEvent(info.event);
            }
        }
    });

    calendar.render();

    async function addEvent(date, name, color) {
        let year = date.getFullYear();
        let month = String(date.getMonth() + 1).padStart(2, '0');
        let day = String(date.getDate()).padStart(2, '0');

        const newRef = db.ref(`calendar/${year}/${month}/${day}`).push();
        await newRef.set({ name, color });

        console.log("✅ 일정 저장 완료:", { name, color });

        // ✅ 새 일정 즉시 반영
        calendar.addEvent({
            id: newRef.key,
            title: name,
            start: `${year}-${month}-${day}`,
            color: color
        });

        console.log("🔄 일정 새로고침 실행");
        setTimeout(() => {
            calendar.refetchEvents();
        }, 500);
    }

    async function deleteEvent(event) {
        let dateParts = event.startStr.split("-");
        let year = dateParts[0];
        let month = dateParts[1];
        let day = dateParts[2];

        console.log("🗑️ 삭제 요청:", event);

        await db.ref(`calendar/${year}/${month}/${day}/${event.id}`).remove();
        event.remove();
        console.log("🗑️ 삭제 완료:", event.id);

        setTimeout(() => {
            calendar.refetchEvents();
        }, 500);
    }
});
